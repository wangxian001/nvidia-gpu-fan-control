# NVIDIA GPU 智能温度管理系统 - V2.1

## 📦 版本信息

| 项目 | 值 |
|------|------|
| **版本** | V2.1 |
| **发布日期** | 2026-01-21 |
| **核心引擎** | v25 |
| **状态** | 正式版 |

> 📖 **[查看详细功能说明文档 (FEATURES.md)](FEATURES.md)** - 了解工作原理、核心价值和投资回报分析

---

## 🌟 新功能亮点

### 智能 X 服务检测

解决用户最常见的部署问题 —— X 服务配置失败。

```
安装时自动检测 → 快速扫描常用端口 → 全面扫描 :0-:99 → 自动安装 Xvfb
```

| 功能 | 说明 |
|------|------|
| **快速检测** | 检测 :0, :1, :2, :8, :9, :99, :98 |
| **全面扫描** | 遍历 :0 到 :99 |
| **Xvfb 自动安装** | 支持 apt/yum/dnf/pacman |
| **服务持久化** | 创建 systemd 服务开机自启 |
| **环境诊断** | 输出详细诊断报告 |

---

## 📂 文件结构

```
releaseV2.1beta/
├── README.md                        # 本文档
│
├── 1-bash-version/                  # Bash 版本（推荐生产环境）
│   ├── fan_control.sh              # 主控制脚本 (51 KB)
│   ├── nvidia-fan-helper           # 包装脚本 (10 KB)
│   ├── install.sh                  # 安装脚本 (7步流程)
│   ├── x_service_helper.sh         # 🆕 X服务智能检测工具
│   ├── README.md                   # Bash 版本说明
│   ├── 故障排查指南.md
│   └── 使用说明书.md
│
└── 2-python-allinone/               # Python 一键安装版
    ├── gpu_fan_control_installer.py # 一键安装器 (46 KB)
    └── README.md                    # Python 版本说明
```

---

## 🚀 快速开始

### 下载方式

#### 方式 A：Git 克隆（推荐）

```bash
# 在服务器上直接克隆
git clone https://github.com/wangxian001/nvidia-gpu-fan-control.git
cd nvidia-gpu-fan-control
```

#### 方式 B：本地 SCP 上传

```bash
# 从本地上传到服务器
scp -r nvidia-gpu-fan-control/ user@server:/tmp/
```

---

### 安装 Bash 版本（推荐）

```bash
# 进入 Bash 版本目录
cd 1-bash-version

# 执行安装
bash install.sh
```

**安装流程（7步）：**
1. 检查系统环境
2. **🆕 检测 X 服务**（自动处理 X 服务问题）
3. 创建工作目录
4. 安装脚本文件
5. 配置 sudo 免密
6. 配置 systemd 服务(开机自启)
7. 启动服务

### 安装 Python 一键版

```bash
# 进入 Python 版本目录
cd 2-python-allinone

# 执行安装
sudo python3 gpu_fan_control_installer.py
```

---

## 🔧 X 服务智能检测工具

当安装脚本检测不到 X 服务时，会自动调用 `x_service_helper.sh`安装X服务。

### 独立使用

```bash
# 交互式安装向导
sudo bash x_service_helper.sh

# 查看诊断报告
sudo bash x_service_helper.sh --diagnose

# 快速检测常用 DISPLAY
sudo bash x_service_helper.sh --quick

# 全面检测 :0 到 :99
sudo bash x_service_helper.sh --full

# 直接安装 Xvfb
sudo bash x_service_helper.sh --install-xvfb
```

### 诊断报告示例

```
============================================================
                 X 服务环境诊断报告
============================================================

【系统信息】
  操作系统: Ubuntu 22.04.1 LTS
  内核版本: 5.15.0-56-generic

【NVIDIA 驱动】
  驱动版本: 525.60.11
  GPU 数量: 2

【X 服务状态】
  nvidia-settings: 已安装
  Xvfb: 已安装
  Xvfb 服务: 运行中

【当前环境 DISPLAY】
  未设置

【可用 X DISPLAY 检测】
  :0: ✖ 不可用
  :1: ✖ 不可用
  :99: ✔ 可用
============================================================
```

---

## 🎯 核心功能

### 1. 智能风扇控制

| 条件 | 动作 |
|------|------|
| 温度 > 70°C 持续 3秒 | 启动手动风扇 (75% 转速) |
| 温度 < 65°C 持续 10秒 | 恢复自动模式 |
| 命令失败 | 自动重试 3 次 |

### 2. 智能功率限制（可选）

| 条件 | 动作 |
|------|------|
| 温度 > 75°C 持续 6秒 | 降低功率到 75% |
| 温度 < 45°C 持续 15秒 | 恢复默认功率 |

### 3. 深度休眠模式

| 条件 | 动作 |
|------|------|
| 温度稳定 15 分钟 | 进入深度休眠 |
| 检测间隔 | 5秒 → 50秒（降低 90%） |
| 任意 GPU 温度变化 > 2°C | 立即唤醒 |

### 4. 多 GPU 同步

- 每个 GPU 独立监控和控制
- 所有 GPU 都稳定才进入深度休眠
- 任一 GPU 唤醒时全部唤醒

---

## ⚙️ 配置参数

编辑 `fan_control.sh`（或 Python 版的配置区）：

```bash
# -------------------- 温度阈值 (°C) --------------------
HIGH_TEMP_THRESHOLD=70      # 启动手动风扇
CRITICAL_TEMP_THRESHOLD=75  # 启动功率限制
LOW_TEMP_THRESHOLD=65       # 恢复自动风扇
COOL_TEMP_THRESHOLD=45      # 恢复默认功率

# -------------------- 风扇设置 --------------------
MANUAL_FAN_SPEED=75         # 手动风扇转速 (0-100)

# -------------------- 功率限制 --------------------
ENABLE_POWER_LIMIT=1        # 1=启用, 0=禁用
REDUCED_POWER_PERCENT=75    # 降低功率百分比

# -------------------- 深度休眠 --------------------
ENABLE_DEEP_SLEEP=1         # 1=启用, 0=禁用
DEEP_SLEEP_THRESHOLD=900    # 15分钟后进入
DEEP_SLEEP_MULTIPLIER=10    # 间隔延长10倍

# -------------------- 日志控制 --------------------
HEARTBEAT_VERBOSE_OUTPUT=0  # 0=简洁打点, 1=详细输出
```

---

## 📊 日志示例

### 启动日志

```

[2026-01-21 11:27:42] 旧日志已重命名为: fan_control_20260121_112742.log并自动归档到 /log/ 子目录
=============================================================================
============GPU 智能温度管理服务启动于: 2026年 01月 21日 星期三 11:27:42 CST=============
=======================GPU功率自动限制功能: 启用======================
=======================GPU闲时深度休眠功能: 启用======================
=============================================================================
[2026-01-21 11:27:42] 初始化 GPU 状态...
[2026-01-21 11:27:42] 自动检测已安装的Nvidia GPU 数量...
[2026-01-21 11:27:42] DEBUG: 方法1检测到 3 个 GPU
[2026-01-21 11:27:42] 最终确认: 检测到 3 个Nvidia GPU
[2026-01-21 11:27:42] GPU 详细信息:
[2026-01-21 11:27:42] GPU 0: NVIDIARTXPRO6000BlackwellWorkstationEdition 
[2026-01-21 11:27:42] GPU 1: NVIDIARTXPRO6000BlackwellWorkstationEdition
[2026-01-21 11:27:42] GPU 2: NVIDIAGeForceRTX5090
[2026-01-21 11:27:42] GPU 0: 分配风扇 0 1
[2026-01-21 11:27:42] GPU 1: 分配风扇 2 3
[2026-01-21 11:27:42] GPU 2: 分配风扇 4 5
[2026-01-21 11:27:42] 监控的GPU (索引): 2 1 0
[2026-01-21 11:27:42] 监控的GPU (风扇映射): 4 5 2 3 0 1
[2026-01-21 11:27:42] 正在查询系统可用 Display :X 服务
[2026-01-21 11:27:42] 开始检测可用的 X DISPLAY...
[2026-01-21 11:27:42]   检查当前环境 DISPLAY=:0 ...
[2026-01-21 11:27:42]   ✔ 当前环境 DISPLAY=:0 可用
[2026-01-21 11:27:42]   ✔ 找到可用 X DISPLAY=:0
[2026-01-21 11:27:42] 功率限制功能已启用，正在计算降额功率...
[2026-01-21 11:27:42] GPU 2: 默认功率 = 575W, 降低后 (75%) = 431W
[2026-01-21 11:27:42] GPU 1: 默认功率 = 600W, 降低后 (75%) = 450W
[2026-01-21 11:27:42] GPU 0: 默认功率 = 600W, 降低后 (75%) = 450W
[2026-01-21 11:27:42] 初始化 GPU 2 状态 (1/3)
[2026-01-21 11:27:43] GPU 2: 风扇模式检查成功：自动模式
[2026-01-21 11:27:43] GPU 2: 功率检测成功，已在额定功率 575W
[2026-01-21 11:27:43] GPU 2 初始化完毕 (风扇: 4 5, 默认功率: 575W) (1/3)
[2026-01-21 11:27:43] 初始化 GPU 1 状态 (2/3)
[2026-01-21 11:27:44] GPU 1: 风扇模式检查成功：自动模式
[2026-01-21 11:27:44] GPU 1: 功率检测成功，已在额定功率 600W
[2026-01-21 11:27:44] GPU 1 初始化完毕 (风扇: 2 3, 默认功率: 600W) (2/3)
[2026-01-21 11:27:44] 初始化 GPU 0 状态 (3/3)
[2026-01-21 11:27:44] GPU 0: 风扇模式检查成功：自动模式
[2026-01-21 11:27:44] GPU 0: 功率检测成功，已在额定功率 600W
[2026-01-21 11:27:44] GPU 0 初始化完毕 (风扇: 0 1, 默认功率: 600W) (3/3)
[2026-01-21 11:27:44] ====== GPU 智能温度管理服务已启动, 当前X服务Display::0 ======
[2026-01-21 11:27:45] GPU 2: 48°C, Fan_mode: AUTO: 0%|0%, GPU-Power: 575W (default 575W)
[2026-01-21 11:27:45] GPU 1: 29°C, Fan_mode: AUTO: 30%|30%, GPU-Power: 600W (default 600W)
[2026-01-21 11:27:46] GPU 0: 33°C, Fan_mode: AUTO: 30%|30%, GPU-Power: 600W (default 600W)
...............................................................^V^V................................................................................................................................................................................................................................................................................................................................................................................................................................................
[2026-01-21 11:43:10] GPU 2: 💤 49°C (基准48°C，温度稳定达15分钟，准备进入深度休眠)

[2026-01-21 11:43:10] GPU 1: 💤 29°C (基准29°C，温度稳定达15分钟，准备进入深度休眠)

[2026-01-21 11:43:10] GPU 0: 💤 33°C (基准33°C，温度稳定达15分钟，准备进入深度休眠)

[2026-01-21 11:43:10] 💤💤💤 所有 GPU 进入深度休眠模式 (检测间隔: 5s → 50s) 💤💤💤
💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤
[2026-01-21 11:53:11] 💤 深度休眠10分钟
💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤.💤💤.💤💤.💤💤.💤💤.💤💤.💤💤.💤

[2026-01-21 14:37:20] 💤 深度休眠90分钟
💤
[2026-01-21 14:38:10] ⏰⏰⏰ 从深度休眠唤醒 (GPU 1 温度变化: 29°C → 39°C, 差值: 10°C) ⏰⏰⏰

[2026-01-21 14:38:10] GPU 1: 39°C, Fan_mode: AUTO: 30%|30%, GPU-Power: 600W (default 600W)
[2026-01-21 14:38:11] GPU 0: 43°C, Fan_mode: AUTO: 30%|30%, GPU-Power: 600W (default 600W)



```

### 正常心跳日志（简洁模式）

```
................................
```

### 进入深度休眠

```
[11:15:00] 💤💤💤 所有 GPU 进入深度休眠模式 (检测间隔: 5s → 50s) 💤💤💤
💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤💤
[11:25:00] 💤 深度休眠10分钟
```

### 从深度休眠唤醒

```
[11:30:00] ⏰⏰⏰ 从深度休眠唤醒 (GPU 0 温度变化: 30°C → 38°C, 差值: 8°C) ⏰⏰⏰
```

### 运行日志示例：
```

[2026-01-21 10:18:33] GPU 1: 风扇手动模式触发 (1/3)
[2026-01-21 10:18:33] GPU 0: 80°C, Fan_mode: MANUAL: 75%|75%, GPU-Power: 600W (default 600W)
[2026-01-21 10:18:33] GPU 0: 功率限制触发 (1/6)
..[2026-01-21 10:18:39] GPU 0: 83°C, Fan_mode: MANUAL: 75%|75%, GPU-Power: 600W (default 600W)
[2026-01-21 10:18:39] GPU 0: 功率限制触发 (2/6)
[2026-01-21 10:18:44] GPU 1: 76°C, Fan_mode: AUTO: 48%|48%, GPU-Power: 600W (default 600W)
[2026-01-21 10:18:44] GPU 1: 功率限制触发 (2/6)
[2026-01-21 10:18:44] GPU 1: 风扇手动模式触发 (2/3)
[2026-01-21 10:18:45] GPU 0: 77°C, Fan_mode: MANUAL: 75%|75%, GPU-Power: 600W (default 600W)
[2026-01-21 10:18:45] GPU 0: 功率限制触发 (3/6)
.[2026-01-21 10:18:50] GPU 1: 82°C, Fan_mode: AUTO: 48%|48%, GPU-Power: 600W (default 600W)
[2026-01-21 10:18:50] GPU 1: 功率限制触发 (3/6)
[2026-01-21 10:18:50] GPU 1: 风扇手动模式触发 (3/3)
[2026-01-21 10:18:50] GPU 1: 启用手动风扇
[2026-01-21 10:18:51] GPU 1: 设置风扇转速为 75%
[2026-01-21 10:18:52] GPU 1: 手动风扇已成功启用，当前转速: 48%|47%
[2026-01-21 10:18:52] GPU 0: 83°C, Fan_mode: MANUAL: 75%|75%, GPU-Power: 600W (default 600W)
[2026-01-21 10:18:52] GPU 0: 功率限制触发 (4/6)
.[2026-01-21 10:18:58] GPU 1: 74°C, Fan_mode: MANUAL: 69%|68%, GPU-Power: 600W (default 600W)
[2026-01-21 10:18:58] GPU 0: 76°C, Fan_mode: MANUAL: 75%|75%, GPU-Power: 600W (default 600W)
[2026-01-21 10:18:58] GPU 0: 功率限制触发 (5/6)
.[2026-01-21 10:19:04] GPU 1: 80°C, Fan_mode: MANUAL: 75%|75%, GPU-Power: 600W (default 600W)
[2026-01-21 10:19:04] GPU 1: 功率限制触发 (1/6)
[2026-01-21 10:19:04] GPU 0: 82°C, Fan_mode: MANUAL: 75%|75%, GPU-Power: 600W (default 600W)
[2026-01-21 10:19:04] GPU 0: 功率限制触发 (6/6)
[2026-01-21 10:19:04] GPU 0: 尝试设置功率限制为 450W
[2026-01-21 10:19:05] GPU 0: 功率限制设置成功 (当前: 450W)
[2026-01-21 10:19:05] GPU 0: 已将功率限制至 450W (默认 600W)
.[2026-01-21 10:19:10] GPU 1: 80°C, Fan_mode: MANUAL: 75%|75%, GPU-Power: 600W (default 600W)
[2026-01-21 10:19:10] GPU 1: 功率限制触发 (2/6)
[2026-01-21 10:19:11] GPU 0: 79°C, Fan_mode: MANUAL: 75%|75%, GPU-Power: 450W (default 600W)


---

## 🔄 常用命令

```bash
# 查看实时日志
tail -f /home/fan_control/fan_control.log
或
tail -n +1 -f /home/fan_control/fan_control.log

# 服务管理
systemctl --user start fan-control.service    # 启动
systemctl --user stop fan-control.service     # 停止
systemctl --user restart fan-control.service  # 重启
systemctl --user status fan-control.service   # 状态

# 查看服务日志
journalctl --user -u fan-control.service -f

# X 服务诊断
sudo bash x_service_helper.sh --diagnose
```

---

## 🐛 故障排查

### Q: 安装时提示 "未找到可用的系统 X 服务"

**解决方案**：安装脚本会自动调用 X 服务智能检测工具，按提示操作即可。

如果自动安装失败，可手动执行X服务检测程序：
```bash
sudo bash x_service_helper.sh
```

### Q: 服务启动后立即停止

检查 X 服务是否正常：
```bash
sudo bash x_service_helper.sh --diagnose
```

### Q: 日志中显示 "手动风扇启用失败，重试"

这是正常的重试机制。V2.1 增加了内部重试，大幅减少了此类日志。

### Q: 深度休眠不生效

检查配置：
```bash
grep "ENABLE_DEEP_SLEEP" /home/fan_control/fan_control.sh
```
确保值为 `1`。

---

## ✨ 更新历史

### V2.1 (2026-01-21)

- ✅ **智能 X 服务检测**：遍历 :0 到 :99 查找可用 X 服务
- ✅ **Xvfb 自动部署**：未找到 X 服务时自动安装 Xvfb 虚拟显示
- ✅ **服务持久化**：Xvfb 作为 systemd 服务开机自启
- ✅ **环境诊断报告**：输出详细的 X 服务环境检测报告
- ✅ **独立工具脚本**：`x_service_helper.sh` 不影响核心代码

### V2.0 (2026-01-21)

- ✅ DISPLAY 全局缓存
- ✅ 内部重试机制
- ✅ 返回值修复
- ✅ 日志优化

### V1.0 (2026-01-15)

- ✅ 深度休眠模式
- ✅ 心跳详细输出开关
- ✅ 多 GPU 同步唤醒

---

## 📋 系统要求

| 项目 | 要求 |
|------|------|
| 操作系统 | Linux (支持 systemd) |
| NVIDIA 驱动 | nvidia-smi, nvidia-settings |
| X 服务器 | Xorg, Xvfb, 或 BMC 虚拟显示器 |
| Bash | 4.0+ (Bash 版本) |
| Python | 3.6+ (Python 版本) |

---

**版本**: V2.1  
**发布日期**: 2026-01-21  
**核心引擎**: v25  
**维护状态**: 正式版
