# 故障排查指南

## 1. X DISPLAY 检测失败

**症状**：日志显示"无法检测到可用的 DISPLAY"

### 解决方案

#### 方法 1：检查现有 X 服务器

```bash
ps aux | grep -E "(X|Xorg|Xvfb)" | grep -v grep
echo $DISPLAY
```

#### 方法 2：安装 Xvfb 虚拟显示器

```bash
# Ubuntu/Debian
sudo apt install xvfb

# 启动虚拟显示器
Xvfb :99 -screen 0 1024x768x24 &
export DISPLAY=:99
```

#### 方法 3：创建 Xvfb systemd 服务

```bash
sudo tee /etc/systemd/system/xvfb.service << 'EOF'
[Unit]
Description=Xvfb Virtual Display
After=network.target

[Service]
ExecStart=/usr/bin/Xvfb :99 -screen 0 1024x768x24
Restart=always

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable xvfb
sudo systemctl start xvfb
```

然后在 fan_control.sh 中添加 `:99` 到 DISPLAY 候选列表。

---

## 2. 风扇控制失败

**症状**：日志显示"手动风扇启用失败"

### 检查步骤

```bash
# 测试 nvidia-settings
nvidia-settings -q GPUFanControlState

# 测试风扇控制
nvidia-settings -a '[gpu:0]/GPUFanControlState=1'
nvidia-settings -a '[fan:0]/GPUTargetFanSpeed=75'
```

### 常见原因

1. **X DISPLAY 问题**：参见第 1 节
2. **权限问题**：检查 sudoers 配置
3. **驱动问题**：更新 NVIDIA 驱动

---

## 3. 功率设置失败

**症状**：日志显示"降功率失败"或"功率恢复失败"

### 检查步骤

```bash
# 查看当前功率
nvidia-smi -q -d POWER

# 测试功率设置
sudo nvidia-smi -i 0 -pl 300
```

### 常见原因

1. **权限不足**：需要 root 或 sudoers 配置
2. **功率超范围**：检查 GPU 支持的功率范围
3. **驱动问题**：更新 NVIDIA 驱动

---

## 4. 深度休眠不生效

**症状**：温度稳定但不进入深度休眠

### 检查步骤

1. 确认 `ENABLE_DEEP_SLEEP=1`
2. 确认温度稳定（变化 < 2°C）
3. 确认处于 IDLE 状态（风扇自动，功率正常）
4. 等待 15 分钟（DEEP_SLEEP_THRESHOLD=900）

### 日志确认

看到以下日志说明准备进入：
```
[10:15:00] GPU 0: 💤 30°C (基准30°C，温度稳定达15分钟，准备进入深度休眠)
```

---

## 5. 服务无法启动

### 检查步骤

```bash
# 查看服务状态
systemctl --user status fan-control.service

# 查看日志
journalctl --user -u fan-control.service -n 50

# 手动运行测试
/home/fan_control/fan_control.sh
```

### 常见原因

1. **脚本权限**：`chmod +x /home/fan_control/fan_control.sh`
2. **路径错误**：检查 systemd 服务文件中的路径
3. **依赖缺失**：检查 nvidia-smi 和 nvidia-settings

---

## 6. 调试技巧

### 前台运行

```bash
/home/fan_control/fan_control.sh
```

### 启用详细日志

```bash
# 编辑 fan_control.sh
HEARTBEAT_VERBOSE_OUTPUT=1
```

### 查看实时日志

```bash
tail -f /home/fan_control/fan_control.log
```

---

**版本**: V1.0 Final
