# 故障排查指南 - Python 版本

## 1. X DISPLAY 检测失败

**症状**：日志显示"无法检测到可用的 DISPLAY"

### 解决方案

#### 方法 1：检查现有 X 服务器

```bash
ps aux | grep -E "(X|Xorg|Xvfb)" | grep -v grep
echo $DISPLAY
```

#### 方法 2：安装 Xvfb 虚拟显示器

```bash
# Ubuntu/Debian
sudo apt install xvfb

# 启动虚拟显示器
Xvfb :99 -screen 0 1024x768x24 &
export DISPLAY=:99
```

#### 方法 3：修改 DISPLAY 候选列表

编辑 `/home/fan_control/gpu_fan_control.py`：

```python
DISPLAY_CANDIDATES = [":99", ":0", ":1", ":2", ":8", ":9", ":98"]
```

---

## 2. 风扇控制失败

**症状**：日志显示"手动风扇启用失败"

### 检查步骤

```bash
# 测试 nvidia-settings
nvidia-settings -q GPUFanControlState

# 测试风扇控制
nvidia-settings -a '[gpu:0]/GPUFanControlState=1'
nvidia-settings -a '[fan:0]/GPUTargetFanSpeed=75'
```

### 常见原因

1. **X DISPLAY 问题**：参见第 1 节
2. **权限问题**：Python 版本需要用户权限运行（非 root）
3. **驱动问题**：更新 NVIDIA 驱动

---

## 3. 功率设置失败

**症状**：日志显示"降功率失败"或"功率恢复失败"

### 检查步骤

```bash
# 查看当前功率
nvidia-smi -q -d POWER

# 测试功率设置（需要 root）
sudo nvidia-smi -i 0 -pl 300
```

### 注意

Python 版本的功率设置使用 `nvidia-smi` 命令，需要确保用户有 sudo 权限。

---

## 4. 深度休眠不生效

**症状**：温度稳定但不进入深度休眠

### 检查步骤

编辑 `/home/fan_control/gpu_fan_control.py`：

```python
ENABLE_DEEP_SLEEP = True
DEEP_SLEEP_THRESHOLD = 900  # 15分钟
```

### 确认条件

1. 温度稳定（变化 < 2°C）
2. 处于 IDLE 状态（风扇自动，功率正常）
3. 等待 15 分钟

---

## 5. 服务无法启动

### 检查步骤

```bash
# 查看服务状态
systemctl --user status gpu-fan-control.service

# 查看日志
journalctl --user -u gpu-fan-control.service -n 50

# 手动运行测试
python3 /home/fan_control/gpu_fan_control.py
```

### 常见原因

1. **Python 版本**：需要 Python 3.6+
2. **路径错误**：检查 systemd 服务文件中的路径
3. **以 root 运行**：不要以 root 身份运行

---

## 6. 调试技巧

### 前台运行

```bash
python3 /home/fan_control/gpu_fan_control.py
```

### 查看实时日志

```bash
tail -f /home/fan_control/fan_control.log
```

---

**版本**: V1.0 Final
